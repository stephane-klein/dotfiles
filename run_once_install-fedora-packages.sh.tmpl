#!/bin/sh

{{ if eq .chezmoi.os "linux" }}
{{   if eq .chezmoi.osRelease.id "fedora" }}
# Fedora-specific code

sudo dnf update -y
sudo dnf install -y \
    git \
    util-linux-user \
    zsh \
    neovim \
    ripgrep \
    patch \
    lm_sensors \
    hddtemp \
    nvme-cli \
    neofetch \
    ncdu \
    rsync \
    pwgen \
    mc \
    direnv \
    htop \
    alacritty \
    jq \
    dnf-plugins-core

# Install Docker (see https://docs.docker.com/engine/install/fedora/)
sudo dnf remove -y podman
sudo dnf config-manager -y \
    --add-repo \
    https://download.docker.com/linux/fedora/docker-ce.repo

sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin iptables fuse-overlayfs

# https://docs.docker.com/engine/install/linux-postinstall/
sudo usermod -aG docker $USER

dockerd-rootless-setuptool.sh install

sudo dnf builddep -y python3

# neovim dependencies: ripgrep
# asdf python dependencies: patch and "dnf builddep python3"

set -e # -e: exit on error

chsh -s $(which zsh)
if ! [ -d ~/.oh-my-zsh ]; then
    CHSH=no sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# Install asdf
if ! [ -d ~/.asdf ]; then
    git -c advice.detachedHead=false clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.10.2
fi
. $HOME/.asdf/asdf.sh
asdf update
asdf plugin add nodejs || true
asdf plugin add pnpm  || true
asdf plugin add python  || true
asdf plugin add yarn || true

echo "Launch 'source ~/.zshrc' to reload zsh configuration"
echo "Launch 'asdf install' to install ~/.tool-versions dependencies"
echo "User added to docker group, then you need to restart session"

{{   end }}
{{ end }}
